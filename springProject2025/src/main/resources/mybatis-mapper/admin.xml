<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
	
	<mapper namespace="com.example.springProject2025.mapper.AdminMapper">
		
		<!-- 상품 문의내역 전체 개수 조회 -->
		<select id="selectInquiryListCount" parameterType="hashmap" resultType="int">
		    SELECT COUNT(*)
		    FROM PRODUCT_INQUIRY I
		    INNER JOIN USERS U ON I.USER_ID = U.USER_ID
		    <where>
		        <if test="keyword != null and keyword != ''">
		            AND (I.TITLE LIKE '%' || #{keyword} || '%' 
		            OR U.NAME LIKE '%' || #{keyword} || '%'
		            OR I.USER_ID LIKE '%' || #{keyword} || '%')
		        </if>
		        <if test="statusOption != null and statusOption != ''">
		            AND I.STATUS = #{statusOption}
		        </if>
		        <if test="startDate != null and startDate != ''">
		            AND I.CDATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
		        </if>
		        <if test="endDate != null and endDate != ''">
		            AND I.CDATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
		        </if>
		    </where>
		</select>
		
		<!-- 상품 문의내역 리스트 불러오기 (페이징 적용) -->
		<select id="selectInquiryList" parameterType="hashmap" resultType="com.example.springProject2025.model.Admin">
		    SELECT *
		    FROM (
		        SELECT SUB.*, ROWNUM AS RN
		        FROM (
		            SELECT I.*, U.NAME
		            FROM PRODUCT_INQUIRY I
		            INNER JOIN USERS U ON I.USER_ID = U.USER_ID
		            <where>
		                <if test="keyword != null and keyword != ''">
		                    AND (I.TITLE LIKE '%' || #{keyword} || '%' 
		                    OR U.NAME LIKE '%' || #{keyword} || '%'
		                    OR I.USER_ID LIKE '%' || #{keyword} || '%')
		                </if>
		                <if test="statusOption != null and statusOption != ''">
		                    AND I.STATUS = #{statusOption}
		                </if>
		                <if test="startDate != null and startDate != ''">
		                    AND I.CDATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
		                </if>
		                <if test="endDate != null and endDate != ''">
		                    AND I.CDATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
		                </if>
		            </where>
		            ORDER BY I.INQUIRY_NO DESC
		        ) SUB
		    ) 
		    WHERE RN > #{startIndex} AND RN &lt;= #{startIndex} + #{pageSize}
		</select>
		
		<!-- 상품 문의내역 상세보기 -->
		<select id="selectInquiry" parameterType="hashmap" resultType="com.example.springProject2025.model.Admin">
			SELECT I.*, U.NAME
			FROM PRODUCT_INQUIRY I
			INNER JOIN USERS U ON I.USER_ID = U.USER_ID
			WHERE INQUIRY_NO = #{inquiryNo}
		</select>
		
		<!-- 상품 문의내역 관리자 답변 등록/수정 -->
		<update id="updateInquiryAnswer" parameterType="hashmap">
			UPDATE PRODUCT_INQUIRY
			SET 
				ANSWER = #{answer},
				ANSWER_DATE = SYSDATE,
				STATUS = 'Y'
			WHERE 
				INQUIRY_NO = #{inquiryNo}
		</update>
		
		
		<!-- 주문 목록 개수 조회 -->
		<select id="selectOrdersListCount" parameterType="hashmap" resultType="int">
		    SELECT COUNT(*)
		    FROM ORDERS O
		    INNER JOIN USERS U ON O.USER_ID = U.USER_ID
		    <where>
		        <if test="keyword != null and keyword != ''">
		            AND (U.NAME LIKE '%' || #{keyword} || '%'
		            OR O.USER_ID LIKE '%' || #{keyword} || '%'
		            OR O.ORDER_NO LIKE '%' || #{keyword} || '%')
		        </if>
		        <if test="statusOption != null and statusOption != ''">
		            AND O.STATUS = #{statusOption}
		        </if>
		        <if test="startDate != null and startDate != ''">
		            AND O.CDATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
		        </if>
		        <if test="endDate != null and endDate != ''">
		            AND O.CDATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
		        </if>
		        AND O.STATUS IN ('신규주문', '배송중', '배송완료')
		    </where>
		</select>
		
		<!-- 주문 목록 조회 (페이징 적용) -->
		<select id="selectOrdersList" parameterType="hashmap" resultType="com.example.springProject2025.model.Admin">
		    SELECT *
		    FROM (
		        SELECT SUB.*, ROWNUM AS RN
		        FROM (
		            SELECT O.ORDER_NO, O.USER_ID, U.NAME, O.PRODUCT_NO, O.QUANTITY,
		                   O.PAYMENT_AMOUNT, O.ADDR, O.PAYMENT_METHOD, O.STATUS,
		                   TO_CHAR(O.CDATE, 'YYYY-MM-DD') AS CDATE,
		                   TO_CHAR(O.UDATE, 'YYYY-MM-DD') AS UDATE,
		                   O.BECAUSE, O.ORDER_REQUEST
		            FROM ORDERS O
		            INNER JOIN USERS U ON O.USER_ID = U.USER_ID
		            <where>
		                <if test="keyword != null and keyword != ''">
		                    AND (U.NAME LIKE '%' || #{keyword} || '%'
		                    OR O.USER_ID LIKE '%' || #{keyword} || '%'
		                    OR O.ORDER_NO LIKE '%' || #{keyword} || '%'
		                    OR O.PRODUCT_NO LIKE '%' || #{keyword} || '%')
		                </if>
		                <if test="statusOption != null and statusOption != ''">
		                    AND O.STATUS = #{statusOption}
		                </if>
		                <if test="startDate != null and startDate != ''">
		                    AND O.CDATE >= TO_DATE(#{startDate}, 'YYYY-MM-DD')
		                </if>
		                <if test="endDate != null and endDate != ''">
		                    AND O.CDATE &lt;= TO_DATE(#{endDate}, 'YYYY-MM-DD') + 0.99999
		                </if>
		                AND O.STATUS IN ('신규주문', '배송중', '배송완료')
		            </where>
		            ORDER BY O.ORDER_NO DESC
		        ) SUB
		    )
		    WHERE RN > #{startIndex} AND RN &lt;= #{startIndex} + #{pageSize}
		</select>
		
		<!-- 주문 상태 업데이트 -->
		<update id="updateOrderStatus" parameterType="hashmap">
		    UPDATE ORDERS
		    SET STATUS = #{newStatus},
		        UDATE = SYSDATE
		    WHERE ORDER_NO = #{orderNo}
		</update>
	</mapper>
